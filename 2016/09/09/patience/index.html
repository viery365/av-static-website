<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Patience</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="/stylesheets/site.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-91621093-1', 'auto');
      ga('send', 'pageview');

    </script>
</head>
<body class="x2016 x2016_09 x2016_09_09 x2016_09_09_patience x2016_09_09_patience_index">
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="/#page-top"><img width="175" src="/images/av-logo-inverse.png" /></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="/#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#why-us">Why us?</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#case-studies">Case Studies</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#subscribe">Subscribe</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
<section id="blog">
  <div class="container">
    <div class="row">
      <div class="col-lg-2">
      </div>
      <div class="col-lg-8 text-left">
        <h2 class='title'><a href="/2016/09/09/patience/">Patience</a></h2>
        <h5 class='date'> 9 Sep 2016</h5>
    <p>Following on from yesterday&rsquo;s <a href="http://nonprofits.agileventures.org/2016/09/08/where-to-change/">post</a> on working with the node stack in AgileBot, Michael had overnight addressed two of my concerns.  He&rsquo;d upgraded from jasmine-node to jasmine-npm, which was allowing our tests to fail in the correct way, i.e. not with catastrophic failures involving no output whatsoever; and he&rsquo;d got the source maps working so that the stack traces were giving us the correct line numbers in the CoffeeScript source files, which involved creating the following line in spec/helpers/helper.js:</p>
<pre class="highlight javascript"><code><span class="nx">require</span><span class="p">(</span><span class="s1">'coffee-script/register'</span><span class="p">);</span>
</code></pre>
<p>It also required adding this jasmine.json file in spec/support:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"spec_dir"</span><span class="p">:</span><span class="w"> </span><span class="s2">"spec"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"spec_files"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"**/*[sS]pec.coffee"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nt">"helpers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"helpers/**/*.js"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nt">"stopSpecOnExpectationFailure"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nt">"random"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>So two of my four concerns from the <a href="http://nonprofits.agileventures.org/2016/09/08/where-to-change/">previous blog post</a> were addressed.  Great work Michael!  After Michael took me through all the changes, we could have easily dived into further refactoring, but I tried to step back and take some notes on our options.  Here&rsquo;s what I wrote down at the time:</p>
<pre class="highlight plaintext"><code>* refactoring the test harness
  - split into separate files
  - pull output logic from mock into test to hard code ??
  - could look at test coverage to discover untested paths OR work them out
  - sepia for recording and playback

VCR --&gt; Sepia --&gt; Yakbak https://github.com/flickr/yakbak
Web mock --&gt; Nock

Sinon vs TestDouble
</code></pre>
<p>A little googling showed there was a more recent (than Sepia) node VCR-like node module called yakbak, but since we had nock working I said let&rsquo;s leave that.  Michael also mentioned harmonising the production and staging environments, since at the moment the staging server was hacked to post Slack alerts to a different channel, in order to run manual end-to-end without spamming the community. So simply merging the work we were doing would break the production instance.  All this work on creating a testing harness had been motivated by our desire to push the hard coded channel mappings into some sort of config package, i.e. to be able to do that refactoring in safety.  So in a fit of &ldquo;what is this all for&rdquo; I just started googling different node config approaches (after noting that <code>process.env.NODE_ENV</code> allowed us to get something similar to <code>RACK_ENV</code> in terms of specifying &lsquo;prodcution&rsquo;, &#39;development&rsquo; or &#39;test&rsquo;).  I found a few config options:</p>

<ul>
<li>dotenv</li>
<li>nconf</li>
<li>node-config</li>
<li>roll our own</li>
</ul>

<p>node-config looked slightly more active so we slapped that in, but I was half way through setting it up and baulked at converting our existing CoffeeScript into JSON.  We threw it out and hand-rolled the following:</p>
<pre class="highlight coffeescript"><code><span class="p">[</span><span class="nx">CHANNELS</span><span class="p">,</span> <span class="nx">GITTER_ROOMS</span><span class="p">]</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s">'./../config/'</span> <span class="o">+</span> <span class="nx">process</span><span class="p">.</span><span class="na">env</span><span class="p">.</span><span class="na">LIVE_ENV</span> <span class="o">+</span> <span class="s">'.coffee'</span><span class="p">)</span>
</code></pre>
<p>We used our own <code>LIVE_ENV</code> var because actually what we wanted was a switch to move from one endpoint to another, and with this switch we now load <code>config/production.coffee</code> vs <code>config/staging.coffee</code> depending on whether we want to hit the main slack instance or not.  We got this working in fairly short order, and so we were tempted to try and knock off a couple of quick refactorings.  Splitting the tests over two files, and pulling a little hard coded logic out of the mock and into the tests themselves.</p>

<p>Here we hit another wall.   Just splitting the tests over two files introduced a very strange problem:</p>
<pre class="highlight plaintext"><code>[tansaku@Samuels-MBP:~/Documents/GitHub/AgileVentures/agile-bot (27_refactor_test_harness)]$ 
→ npm test

&gt; agile-bot@1.0.0 test /Users/tansaku/Documents/GitHub/AgileVentures/agile-bot
&gt; jasmine ENABLE_ROLLBAR=false GITTER_API_TOKEN=101010

Started
......._http_client.js:55
    throw new Error('Protocol "' + protocol + '" not supported. ' +
    ^

Error: Protocol "http:" not supported. Expected "https:"
  at new ClientRequest (_http_client.js:55:11)
  at RequestOverrider.end (/Users/tansaku/Documents/GitHub/AgileVentures/agile-bot/node_modules/nock/lib/request_overrider.js:251:24)
  at OverriddenClientRequest.RequestOverrider.req.end (/Users/tansaku/Documents/GitHub/AgileVentures/agile-bot/node_modules/nock/lib/request_overrider.js:159:7)
  at Request.end (/Users/tansaku/Documents/GitHub/AgileVentures/agile-bot/node_modules/request/request.js:1397:14)
  at end (/Users/tansaku/Documents/GitHub/AgileVentures/agile-bot/node_modules/request/request.js:554:16)
  at Immediate.&lt;anonymous&gt; (/Users/tansaku/Documents/GitHub/AgileVentures/agile-bot/node_modules/request/request.js:581:7)
  at runCallback (timers.js:574:20)
  at tryOnImmediate (timers.js:554:5)
  at processImmediate [as _immediateCallback] (timers.js:533:5)

npm ERR! Test failed.  See above for more details.

</code></pre>
<p>Running all the tests in a single file did not lead to this issue.  Googling the error provided little help, and we were hunting for the source of the issue by commenting out different sections of the code; back to C debugging style.  Again it&rsquo;s entirely possible that our model of the system was just not sufficiently evolved to make sense of this.  None of our mocks or requests had any &ldquo;http&rdquo; requests, it was all &ldquo;https&rdquo;, so the error above didn&rsquo;t make much sense, and the stack trace didn&rsquo;t relate to any of our code.  I was suspecting it was a timing issue, and throwing up my hands in frustration, I was like, let&rsquo;s just get this out with the tests in a single file.  I want to get some noticeable improvement into production.  We had at least got the variable config working.</p>

<p>Michael and I decided to split.  He was keen to hunt this bug down, I was anxious to deploy something.  We talked about the tension between wanting to learn a new stack and wanting to deliver features to clients.  We did a &ldquo;side by side&rdquo; session for a while, where Michael hunted on that bug, and I tried to deploy where we were up to staging.  I think we just ended up distracting each other. I got caught in another silly bug where I failed to read the stack trace properly:</p>
<pre class="highlight plaintext"><code>[tansaku@Samuels-MBP:~/Documents/GitHub/AgileVentures/agile-bot (staging)]$ 
→ npm test

&gt; agile-bot@1.0.0 test /Users/tansaku/Documents/GitHub/AgileVentures/agile-bot
&gt; jasmine ENABLE_ROLLBAR=false GITTER_API_TOKEN=101010

Started
.......undefined:1
undefined
^

SyntaxError: Unexpected token u in JSON at position 0
  at Object.parse (native)
  at Request._callback (/Users/tansaku/Documents/GitHub/AgileVentures/agile-bot/scripts/av-hangouts-notifications.coffee:33:22)
  at self.callback (/Users/tansaku/Documents/GitHub/AgileVentures/agile-bot/node_modules/request/request.js:187:22)
  at emitOne (events.js:96:13)
  at Request.emit (events.js:188:7)
  at Request.onRequestError (/Users/tansaku/Documents/GitHub/AgileVentures/agile-bot/node_modules/request/request.js:813:8)
  at emitOne (events.js:96:13)
  at OverriddenClientRequest.emit (events.js:188:7)
  at /Users/tansaku/Documents/GitHub/AgileVentures/agile-bot/node_modules/nock/lib/request_overrider.js:206:11
  at _combinedTickCallback (internal/process/next_tick.js:67:7)
  at process._tickCallback (internal/process/next_tick.js:98:9)

npm ERR! Test failed.  See above for more details.
</code></pre>
<p>I was trying to follow up by making all the channel IDs in the staging config point to testing channels and changing one of them generated the above error.  In my frustration I totally missed the fact that this JSON error was not related to the config file per se.  Remember that we rolled our own config and we were pulling in coffee files, not JSON.  I spun my wheels for 20 minutes thinking I had some bad character in the config file, before realising that the tests were hard coded to the particular Gitter channel ID I was trying to change in config.</p>

<p>If I&rsquo;d calmly read the stack trace I&rsquo;d have seen the failure was actually at a different point in our code i.e. <code>av-hangouts-notifications.coffee:33</code> which is the last line in the following:</p>
<pre class="highlight coffeescript"><code>  <span class="nx">send_gitter_message_avoid_repeats</span> <span class="o">=</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">request</span><span class="p">.</span><span class="na">get</span> <span class="s">"https://api.gitter.im/v1/rooms/</span><span class="si">#{</span><span class="nx">GITTER_ROOMS</span><span class="p">[</span><span class="s">'saasbook/AV102'</span><span class="p">]</span><span class="si">}</span><span class="s">/chatMessages"</span><span class="p">,</span>
      <span class="na">auth</span><span class="o">:</span>
        <span class="na">bearer</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="na">env</span><span class="p">.</span><span class="na">GITTER_API_TOKEN</span>
    <span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">payload</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="na">parse</span> <span class="nx">body</span>
</code></pre>
<p>I think what was happening was that changing the config meant that our test was stubbing the wrong end point and so our test was really trying to hit Gitter and getting back some data it couldn&rsquo;t parse.  Looking at the line in question we can see it is about parsing JSON so the unexpected token makes some sense.  Easy mistake, but my frustration at an unfamiliar stack and my worries about delivering visible changes to the community were not helping me make progress.  I&rsquo;d got used to ignoring the stack traces earlier since they had not been something we could follow.  A great back to basics lesson for me.</p>

<p>There&rsquo;s also an important question about how we&rsquo;re working.  Would Michael and I have made faster progress if we&rsquo;d engaged on both problems together and one of us had given ground about which to work on first?  Over night Michael&rsquo;s made progress on the multi-file issue and also on getting more sophisticated debugging to work which sounds like a wonderful step forward.  Michael has more coding time available to him.  I have lots of administrative and family commitments.  We need to keep working on the best approach to making progress.  I feel we have a good dialogue about our work modes.  Let&rsquo;s see how we can improve next week.  I&rsquo;m definitely inspired by Michael&rsquo;s tenacity to want to get to the point where we can work efficiently in the node tech stack.  We&rsquo;ve made a lot of progress.  Although even with a small legacy app I feel like we are balancing on a lot of brittleness.  Could we write something cleaner in the latest version of express?  Will I break down and create something in Sinatra?</p>

<p>Oh and I forgot to mention, the agile-bot on staging was thrashing, dumping huge data dumps from slack onto the log.  I had to shut it down.  We&rsquo;ve upgraded the whole stack of the agile-bot without checking that this set up will work in the deployment environment!  More back to basics &hellip; I suspect I will need all my patience :-)</p>

        <h2 class='author'>by Sam Joseph</h2>
      </div>  
      <div class="col-lg-2">
      </div>
    </div>  
  </div>  
</section>  
<footer>
    <div class="container">
        <section id="contact">
        <div class="row">
            <div class="col-md-4">
                <h3>AgileVentures</h3>
                <p class="blurb text-muted">Our purpose is to develop better more affordable software solutions to enable non-profits to be more effective and more efficient. We also host a <a href="http://www.agileventures.org">learning community</a> around <a href="https://www.edx.org/xseries/agile-development-using-ruby-rails">free online courses</a> that enable developers to improve their team and software skills, and then to apply them on socially useful projects for non-profits. We are a Charitable Incorporated Organisation (CIO) in the UK. Ref #1170963</p>
            </div>
            <div class="col-md-4">
                <h3>What we do</h3>
                <div class="list">
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Websites</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Apps</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Process Automation</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Software Projects</span></i>
                </div>
                <h4>More on our <a href="/blog">Blog</a></h4>
            </div>
            <div class="col-md-4">
                <h3>Contact Us</h3>
                <div class="contact-list">
                  <!-- <i class="fa fa-envelope fa-lg fa-text fa-fw"><span class='font-override'>&nbsp;&nbsp;</i> -->
                  <i class="fa fa-lg fa-text"><a class='mail' href='mailto:nonprofits@agileventures.org'>nonprofits@<wbr>agileventures.org</a></span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>AgileVentures</span></i>
                  <!-- <i class="fa fa-map-marker fa-lg fa-text fa-fw"></i> -->
                  <i class="fa fa-lg fa-text"><span class='font-override'>The Lodge</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>64 Pinner Road</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>Harrow, HA1 4HZ</span></i>
                </div>
            </div>
        </div>
        </section>
        <div class="row">
            <div class="col-md-4">
                <ul class="list-inline quicklinks">
                    <li><a href="/privacy">Privacy Policy</a>
                    </li>
                    <li><a href="/terms">Terms of Use</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-4">
                <span class="copyright">Copyright &copy; AgileVentures 2017</span>
            </div>
            <div class="col-md-4">
                <ul class="list-inline social-buttons">
                    <li><a href="https://twitter.com/AgileVentures"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li><a href="https://www.facebook.com/agileventures"><i class="fa fa-facebook"></i></a>
                    </li>
                    <li><a href="https://www.linkedin.com/company/agileventures"><i class="fa fa-linkedin"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    </section>
</footer>


</body>
</html>
