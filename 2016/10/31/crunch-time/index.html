<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Crunch Time</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="/stylesheets/site.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />

</head>
<body class="x2016 x2016_10 x2016_10_31 x2016_10_31_crunch-time x2016_10_31_crunch-time_index">
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="/#page-top"><img width="175" src="/images/av-logo-inverse.png" /></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="/#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#services">Why us?</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#portfolio">Case Studies</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#subscribe">Subscribe</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
<section id="blog">
  <div class="container">
    <div class="row">
      <div class="col-lg-2">
      </div>
      <div class="col-lg-8 text-left">
        <h2 class='title'><a href="/2016/10/31/crunch-time/">Crunch Time</a></h2>
        <h5 class='date'>31 Oct 2016</h5>
    <p>It was crunch time.  No answer from Google on the Hangout Button API.  It was dismantle our events framework or make some changes to the manual update functionality that would allow some parts of joining an event to start working again.  The problem was that even though our hangout plugin was automatically loaded into Hangouts started via YouTube, that hangout would only load for people who had previously run a successful AgileVentures hangout, and even then was now not set to communicate back to the AgileVenture&rsquo;s server.</p>

<p>The current architecture would send notifications about a hangout on Slack and provide a link to that hangout on the AgileVenture&rsquo;s site <em>if</em> the hangout was started from a button on the AV site, and our custom plugin was loaded into the hangout with the right data payload.  Maybe we could adjust the plugin to be <a href="https://developers.google.com/+/hangouts/publishing">installable</a> into a YouTube started hangout and then connect back to our server to support the notifications and link display.  Certainly apps like <a href="https://twitter.com/_madeye">MadEye</a> used to work like that, but they&rsquo;ve shut down and who knows how long Google will continue supporting the Hangout Plugin ecosystem.  It was clear from the discussions on Thursday that it made sense to start by enabling users to manually specify the hangout URL; have that act of manual specification lead to Slack notifications, and keep the links to the hangout on AgileVentures live for the duration the event.</p>

<p><img alt="example of a live event link in AV" src="https://www.dropbox.com/s/5vseylfvnfeufd5/Screenshot%202016-10-31%2009.46.02.png?dl=1" /></p>

<p>The manual update of the URL had been broken for repeating events; a bug I had fixed earlier in the week.  Now the trouble was that following a manual update the event would only stay &ldquo;live&rdquo; for 2 minutes.  As Michael pointed out this was because when the whole system was working the hangout plugin would be sending back telemetry every 2 minutes and would keep the event &ldquo;live&rdquo;.  Effectively we wanted the site to be able to display &ldquo;live&rdquo; events accurately, so that people thinking about joining would be receiving accurate information about whether to expect others in the hangout.  All this was still short of my imagined ideal set up where you are able to see who is in a live hangout before you join.  This functionality was briefly available on the helpdesk hangouts we used to have in the &ldquo;Agile Development using Ruby on Rails&rdquo; MOOC, however it never worked for Hangouts on Air.  If the Google Hangout API had stayed stable, it&rsquo;s something we might have been able to add fairly soon.  As it is now we&rsquo;re just scrambling to keep existing features running.</p>

<p>Maybe I&rsquo;m deluding myself about this, but I really do imagine that an infrastructure that allowed you to browse a set of collaborative events, seeing a preview of what is going on and who is participating, could recreate some of the wandering, networking aspect of an unconference or similar, but support it completely remotely. (maybe I should do a UI mockup &hellip;).  Anyway, let me tell you how I fixed the manual URL update to support &ldquo;live for the duration&rdquo; and slack notifications.  I started with a cucumber test, splitting the existing edit hangout URL tests into a separate feature file so that I could reduce the dependencies between the background steps.  Long cucumber files with multiple scenarios relying on the same set of background set up start to feel almost as dangerous as tests relying about a large set of fixtures.  Here&rsquo;s the new feature file header:</p>
<pre class="highlight gherkin"><code><span class="kd">Feature</span><span class="p">:</span> Manual Edit of Hangout URL
  As a person involved in an event
  So that I can ensure everyone can access the correct link to join an event
  I would like to have means of editing the hangout URL
</code></pre>
<p>And here&rsquo;s the smaller(!) set of background steps I finally converged on:</p>
<pre class="highlight gherkin"><code>  <span class="kn">Background</span><span class="p">:</span>
    <span class="err">Given the date is "2014-02-04 06</span><span class="p">:</span><span class="err">59</span><span class="p">:</span><span class="err">00"</span>
    <span class="err">And following events exist</span><span class="p">:</span>
      <span class="p">|</span> <span class="nv">name</span>          <span class="p">|</span> <span class="nv">description</span>          <span class="p">|</span> <span class="nv">category</span>      <span class="p">|</span> <span class="nv">start_datetime</span>          <span class="p">|</span> <span class="nv">duration</span> <span class="p">|</span> <span class="nv">repeats</span> <span class="p">|</span> <span class="nv">time_zone</span> <span class="p">|</span> <span class="nv">repeats_every_n_weeks</span> <span class="p">|</span> <span class="nv">repeats_weekly_each_days_of_the_week_mask</span> <span class="p">|</span>
      <span class="p">|</span> <span class="n">Scrum</span>         <span class="p">|</span> <span class="n">Daily</span> <span class="n">scrum</span> <span class="n">meeting</span>  <span class="p">|</span> <span class="n">Scrum</span>         <span class="p">|</span> <span class="n">2014/02/04</span> <span class="n">07:00:00</span> <span class="n">UTC</span> <span class="p">|</span> <span class="n">15</span>      <span class="p">|</span> <span class="n">never</span>   <span class="p">|</span> <span class="n">UTC</span>       <span class="p">|</span>                       <span class="p">|</span>                                           <span class="p">|</span>
      <span class="p">|</span> <span class="n">Repeat</span> <span class="n">Scrum</span>  <span class="p">|</span> <span class="n">Daily</span> <span class="n">scrum</span> <span class="n">meeting</span>  <span class="p">|</span> <span class="n">Scrum</span>         <span class="p">|</span> <span class="n">2014/02/03</span> <span class="n">07:00:00</span> <span class="n">UTC</span> <span class="p">|</span> <span class="n">15</span>      <span class="p">|</span> <span class="n">weekly</span>  <span class="p">|</span> <span class="n">UTC</span>       <span class="p">|</span> <span class="n">1</span>                     <span class="p">|</span> <span class="n">15</span>                                        <span class="p">|</span>
    <span class="err">And the following hangouts exist</span><span class="p">:</span>
      <span class="p">|</span> <span class="nv">Start</span> <span class="nv">time</span>          <span class="p">|</span> <span class="nv">Title</span>        <span class="p">|</span> <span class="nv">Project</span>    <span class="p">|</span> <span class="nv">Category</span> <span class="p">|</span> <span class="nv">Event</span>        <span class="p">|</span> <span class="nv">EventInstance</span> <span class="nv">url</span>   <span class="p">|</span> <span class="nv">Youtube</span> <span class="nv">video</span> <span class="nv">id</span> <span class="p">|</span> <span class="nv">End</span> <span class="nv">time</span>            <span class="p">|</span>
      <span class="p">|</span> <span class="n">2012-02-04</span> <span class="n">07:00:00</span> <span class="p">|</span> <span class="n">HangoutsFlow</span> <span class="p">|</span> <span class="n">WebsiteOne</span> <span class="p">|</span> <span class="n">Scrum</span>    <span class="p">|</span> <span class="n">Repeat</span> <span class="n">Scrum</span> <span class="p">|</span> <span class="n">http://hangout.test</span> <span class="p">|</span> <span class="n">QWERT55</span>          <span class="p">|</span> <span class="n">2014-02-04</span> <span class="n">07:02:00</span> <span class="p">|</span>
      <span class="p">|</span> <span class="n">2014-02-05</span> <span class="n">07:00:00</span> <span class="p">|</span> <span class="n">HangoutsFlow</span> <span class="p">|</span> <span class="n">WebsiteOne</span> <span class="p">|</span> <span class="n">Scrum</span>    <span class="p">|</span> <span class="n">Repeat</span> <span class="n">Scrum</span> <span class="p">|</span> <span class="n">http://hangout.test</span> <span class="p">|</span> <span class="n">QWERT55</span>          <span class="p">|</span> <span class="n">2014-02-05</span> <span class="n">07:03:00</span> <span class="p">|</span>
    <span class="nf">And</span> I am logged in
    <span class="nf">And</span> I have Slack notifications enabled
</code></pre>
<p>These are irritatingly long at the moment partly due to the need to specify the <code>repeats_every_n_weeks</code> and <code>repeats_weekly_each_days_of_the_week_mask</code> fields on Events.  Trying to move fast I wasn&rsquo;t about to start refactoring that, although I&rsquo;d love to rewrite both of the above <code>following entities exist</code> steps to avoid using factories that are shared with our specs, and make the whole thing more readable.</p>

<p>I drove from the simpler non-repeating event situation:</p>
<pre class="highlight gherkin"><code>  <span class="nt">@javascript</span>
  <span class="kn">Scenario</span><span class="p">:</span> Edit Hangout URL and ensure event stays live
    <span class="nf">And</span> I navigate to the show page for event <span class="s">"Scrum"</span>
    <span class="nf">And</span> I open the Edit URL controls
    <span class="err">And I fill in "hangout_url" with "http</span><span class="p">:</span><span class="err">//test.com"</span>
    <span class="nf">And</span> I click on the Save button
    <span class="err">Then I should see link "Join now" with "http</span><span class="p">:</span><span class="err">//test.com"</span>
    <span class="err">And I jump to one minute before the end of the event at "2014-02-04 07</span><span class="p">:</span><span class="err">14</span><span class="p">:</span><span class="err">00"</span>
    <span class="nf">And</span> I navigate to the show page for event <span class="s">"Scrum"</span>
    <span class="err">Then I should see link "Join now" with "http</span><span class="p">:</span><span class="err">//test.com"</span>
</code></pre>
<p>Naturally this was failing due to no updates from the plugin, and so I dropped to the RSpec level and drove the creation of a new field on EventInstance called <code>url_set_directly</code> to serve as a flag to indicate that the hangout URL had been set manually. I&rsquo;d been struggling with the domain entity name of EventInstance, which we use to represent a Hangout, and the names are used interchangeably throughout the codebase.  I had been thinking we should consolidate on Hangout, but actually now the future of Hangouts is up in the air, EventInstance starts to feel like the better choice, although surely there must be a better term?  Anyhow, don&rsquo;t get sidetracked making domain model tweaks when you&rsquo;re trying to get a fix into production!  I RSpec&rsquo;d in the EventInstance spec like so:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">EventInstance</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s1">'has url_set_directly default to false'</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">hangout</span><span class="p">.</span><span class="nf">url_set_directly</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_falsey</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s1">'hangout_url is present and is not finished'</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">hangout</span><span class="p">.</span><span class="nf">hangout_url</span> <span class="o">=</span> <span class="s1">'test'</span>
      <span class="n">hangout</span><span class="p">.</span><span class="nf">hoa_status</span> <span class="o">=</span> <span class="s1">'anything'</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'url manually overridden'</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">hangout</span><span class="p">.</span><span class="nf">url_set_directly</span> <span class="o">=</span> <span class="kp">true</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s1">'reports live if the link is older than 2 minutes, and event duration not expired'</span> <span class="k">do</span>
        <span class="n">allow</span><span class="p">(</span><span class="n">hangout</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:within_current_event_duration?</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
        <span class="n">allow</span><span class="p">(</span><span class="no">Time</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:now</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s1">'10:02:01 UTC'</span><span class="p">))</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">hangout</span><span class="p">.</span><span class="nf">live?</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_truthy</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre>
<p>which naturally failed since there was no such field as <code>url_set_directly</code>, which lead me to generate this migration:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">AddUrlSetDirectlyColumnToEventInstance</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:event_instances</span><span class="p">,</span> <span class="ss">:url_set_directly</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>And made the following changes in the EventInstance class:</p>
<pre class="highlight ruby"><code>  <span class="k">def</span> <span class="nf">live?</span>
    <span class="n">started?</span> <span class="o">&amp;&amp;</span> <span class="n">hoa_status</span> <span class="o">!=</span> <span class="s1">'finished'</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">updated_within_last_two_minutes?</span> <span class="o">||</span> <span class="n">manually_updated_event_not_finished?</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">manually_updated_event_not_finished?</span>
    <span class="n">url_set_directly</span> <span class="o">&amp;&amp;</span> <span class="n">within_current_event_duration?</span>
  <span class="k">end</span>

</code></pre>
<p>The spec&rsquo;s passed, although not the cukes.  Notice I&rsquo;d stubbed the EventInstance (hangout) in the spec to allow calling <code>within_current_event_duration?</code> on EventInstance objects. One usually doesn&rsquo;t stub methods in the object under test, but here I was planning to delegate that call straight out to a collaborator. I wanted to be able to ask that of an EventInstance instance, and I could drive addig that with another spec for a delegation:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">EventInstance</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">delegate_method</span><span class="p">(</span><span class="ss">:within_current_event_duration?</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="ss">:event</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
<p>and the code to make that spec green was:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">EventInstance</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

  <span class="n">delegate</span> <span class="ss">:within_current_event_duration?</span><span class="p">,</span> <span class="ss">to: :event</span>
</code></pre>
<p>It would be really tidy to say that then the cukes went green, but there was an additional change in the view (to set the url<em>set</em>directly flag) and then a good hour of getting lost in the time elements of Event, the IceCube scheduling gem etc. etc.Ultimately I think it was all down to slight incorrectness in the way I was setting the dates in the Cucumber steps.   Those sorted out everything was passing, and I got a <a href="https://github.com/AgileVentures/WebsiteOne/pull/1370">PR</a> in, which Raoul deployed and we tested in staging.  It seemed to keep the event live, but Slack notifications were not going through.  That took the addition of several more parameters to the view, and another <a href="https://github.com/AgileVentures/WebsiteOne/pull/1372">PR</a> which ultimately worked.  I&rsquo;d definitely gone over budget with the time on this, I was not comfortable with some of the compromises I had made on the Cucumber steps, but I had something working that would allow Jo√£o to run the Pacific Rim scrum in such a way that with a single manual step he&rsquo;d be able to notify everyone on Slack, and the links on the AV site would stay live for 15 minutes to let people into the Scrum.</p>

<p>The set up also seemed to work at least partially for some less experienced Scrum masters over the weekend, but more support and scaffolding is clearly needed.  I also think that <code>url_set_directly</code> needs to be a date rather than a flag, since I expect some repeating events may now say &ldquo;live&rdquo; incorrectly &hellip; although maybe events all should say live for their duration? We would just need some kind of popup message in the hangout for people entering to let them know that no one else is there yet and that&rsquo;s okay, and people could still meetup.  Of course Hangout&rsquo;s can&rsquo;t be re-broadcast &hellip; is it worth pursuing a Hangout plugin to handle the new setup or will work invested there have to be thrown out when/if Google completely sunsets Hangouts?</p>

<p>It often feels like Hangouts is an engineeering black hole.  Perhaps now it&rsquo;s time to switch focus onto adding PayPal payment support, and allowing people to sponsor each other&rsquo;s Premium memberships on AgileVentures.  I have the feeling we could start receiving payments from at least two people if those two features were in place, so perhaps that&rsquo;s the best focus?  In the meantime I could get some emails off to all the Hangout alternatives with a list of our needed features, e.g. recordability, URL to conference etc. &hellip; On to the next Crunch Time!</p>

<p>Related Videos</p>

<ul>
<li><a href="https://www.youtube.com/watch?v=nJVeelkuoGw">&ldquo;Kent Beck&rdquo; Scrum</a></li>
</ul>

        <h2 class='author'>by Sam Joseph</h2>
      </div>  
      <div class="col-lg-2">
      </div>
    </div>  
  </div>  
</section>  
<footer>
    <div class="container">
        <section id="contact">
        <div class="row">
            <div class="col-md-4">
                <h3>AgileVentures</h3> 
                <p class="blurb text-muted">Our purpose is to develop better more affordable software solutions to enable non-profits to be more effective and more efficient. We also host a <a href="http://www.agileventures.org">learning community</a> around <a href="https://www.edx.org/xseries/agile-development-using-ruby-rails">free online courses</a> that enable developers to improve their team and software skills, and then to apply them on socially useful projects for non-profits. We are awaiting approval of our application to become a Charitable Incorporated Organisation (CIO) in the UK.</p>
            </div>
            <div class="col-md-4">
                <h3>What we do</h3>
                <div class="list">
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Websites</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Apps</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Process Automation</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Software Projects</span></i>
                </div>
                <h4>More on our <a href="/blog">Blog</a></h4>
            </div>
            <div class="col-md-4">
                <h3>Contact Us</h3>
                <div class="contact-list">
                  <!-- <i class="fa fa-envelope fa-lg fa-text fa-fw"><span class='font-override'>&nbsp;&nbsp;</i> -->
                  <i class="fa fa-lg fa-text"><a class='mail' href='mailto:nonprofits@agileventures.org'>nonprofits@<wbr>agileventures.org</a></span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>AgileVentures</span></i>
                  <!-- <i class="fa fa-map-marker fa-lg fa-text fa-fw"></i> -->
                  <i class="fa fa-lg fa-text"><span class='font-override'>The Lodge</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>64 Pinner Road</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>Harrow, HA1 4HZ</span></i>
                </div>
            </div>
        </div>
        </section>
        <div class="row">
            <div class="col-md-4">
                <ul class="list-inline quicklinks">
                    <li><a href="/privacy">Privacy Policy</a>
                    </li>
                    <li><a href="/terms">Terms of Use</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-4">
                <span class="copyright">Copyright &copy; AgileVentures 2016</span>
            </div>
            <div class="col-md-4">
                <ul class="list-inline social-buttons">
                    <li><a href="https://twitter.com/AgileVentures"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li><a href="https://www.facebook.com/agileventures"><i class="fa fa-facebook"></i></a>
                    </li>
                    <li><a href="https://www.linkedin.com/company/agileventures"><i class="fa fa-linkedin"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    </section>
</footer>

</body>
</html>
